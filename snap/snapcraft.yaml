name: cos-registration-agent
base: core22
version: git
summary: COS registration agent is identifying the robot to the COS server
description: |
  COS registration agent is responsible for identifying 
  the robot to the COS server as well as uploading robot 
  specific data to the server (dashboard, UID, etc).

grade: devel
confinement: strict

slots:
  configuration:
    interface: content
    source:
      read:
        - $SNAP

# Set the REQUESTS_CA_BUNDLE to make sure that
# python requests library use host certificates.
# Otherwise it will use the ones provided by `certifi`,
# which will not include missing self-signed COS certificates
environment:
  REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt

plugs:
  rob-cos-common-write:
    interface: content
    target: $SNAP_COMMON/rob-cos-shared-data
  configuration-read:
    interface: content
    target: $SNAP_COMMON/configuration
  device-cos-settings-observe:
    interface: confdb
    account: VX84EGFo6txXHSNk4l55reEiaU5n7I7R
    view: device-cos-settings/observe-device-cos-settings

hooks:
  configure:
    plugs: [network, home]
  connect-plug-configuration-read:
    plugs: [network]
  connect-plug-rob-cos-common-write:
    plugs: [network]
#  connect-plug-device-cos-settings-observe:
#    plugs: [network]
#  observe-view-device-cos-settings-observe:
#    plugs: [network]
  remove:
    plugs: [network, home, configuration-read]

parts:
  local-files:
    plugin: dump
    source: snap/local/
    organize:
      '*.sh': usr/bin/
  cos-registration-agent:
    plugin: python
    source: .

apps:
  update-device-configuration:
    command: usr/bin/update-device-configuration.sh
    daemon: oneshot
    install-mode: disable
    plugs: [network, rob-cos-common-write, configuration-read, home]
  cos-registration-agent:
    command: bin/cos-registration-agent
    plugs: [network, rob-cos-common-write, configuration-read, device-cos-settings-observe, home]
